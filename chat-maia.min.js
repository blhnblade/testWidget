function chatWidget(){
    const globalThis = this;
  
    this.config = {}
  
    this.init = ()=>{
      this.insertChat()
      this.loadMessageHistory()
      this.autoSizeWidth()
      this.sendingToChat()
      this.sendingUsingEnter()
      this.textareaCancelNewlineOn()
      this.openChat()
      this.closeChat()
      this.resizeChatWidth()
      this.textareaAutoHeight()
      this.checkFirstOpening.init()
      this.chatAutoStart.init()
      this.iconForUnreadMessage.checkNotifLocaleStorage()
      this.insertMetaTag()
      this.record.init()
    },
  
  
    this.checkFirstOpening = {
      init(){
        this.setHandler()
      },
      isOpened: false,
      setHandler(){
        globalThis.chatBubble.addEventListener('click', this.handler)
      },
      handler(){
        globalThis.checkFirstOpening.isOpened = true
        this.removeEventListener('click', globalThis.checkFirstOpening.handler)
      }
    }
  
  
    this.insertChat = (colorSettings)=>{
      document.head.insertAdjacentHTML('beforeend', '<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">');  
      const style = document.createElement('style');
      style.innerHTML = `
      .chat-widget-container * {
        font-family: 'Inter', 'Segoe UI';
        box-sizing: border-box;
        padding: 0px;
        margin: 0px;
        border: none;
        width: auto;
        min-width: auto;
        max-width: auto;
        min-height: auto;
        max-height: auto;
        height: auto;
        background: none;
        box-shadow: none;
        color: initial;
      }
      .chat-widget-container textarea:focus{
        outline: none;
        border: none;
        background-color: #F2F3F7;
        box-shadow: none;
      }
      .hidden {
        display: none!important;
      }
      .chat-widget-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        flex-direction: column;
        z-index: 1000;
      }
      .chat-bubble{
        font-size: 30px;
        line-height: 36px;
        border-radius: 100%;
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background-color: ${this.config?.circle_color || 'gray'};
        animation-name: opacity-emergence;
        animation-duration: .2s;
        position: relative;
      }
      .chat-bubble svg{
        width: 48px;
        height: 48px;
        color: rgba(255,255,255,1);
        display: block;
        vertical-align: middle;
      }
      .chat-unread-message-icon{
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        min-width: 20px;
        max-width: 20px;
        height: 20px;
        max-height: 20px;
        min-height: 20px;
        border-radius: 50%;
        background-color: #00D35B;
        animation-name: opacity-emergence;
        animation-duration: .2s;
      }
      .chat-popup{
        height: 70vh;
        max-height: 70vh;
        transition: all 0.3s;
        overflow: hidden;
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4,0,0.2,1);
        transition-duration: 150ms;
        box-shadow: 0 0 #0000, 0 0 #0000, 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 6px;
        font-size: 14px;
        line-height: 20px;
        background-color: rgba(255,255,255, 1);
        width: 384px;
        max-width: 384px;
        min-width: 384px;
        display: flex;
        flex-direction: column;
        position: absolute;
        bottom: 80px;
        right: 0;
      }
      .chat-header{
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        background-color: ${this.config?.header_color || 'gray'}
      }
      .chat-header h3{
        font-size: 18px;
        line-height: 28px;
        font-weight: 500;
        margin: 0;
        color: white;
        user-select: none;
      }
      .chat-header #close-popup{
        min-width: 24px !important;
        width: 24px !important;
        height: 24px !important;
        min-height: 24px !important;
        color: rgba(255,255,255,1);
        border-style: none;
        cursor: pointer;
        background-color: transparent;
        background-image: none;
        text-transform: none;
        -webkit-appearance: button;
        font-family: inherit;
        font-size: 100%;
        margin: 0;
        padding: 0px;
        text-indent: 0px;
        text-shadow: none;
        display: flex;
        align-items:center;
        justify-content: center
        letter-spacing: normal;
        word-spacing: normal;
        text-rendering: auto;
      }
      .chat-header button svg{
        width: 24px;
        height: 24px;
      }
      .chat-messages{
        flex: 1 1 0%;
        padding: 16px;
        overflow-y: auto;
        scrollbar-width: none;
        scrollbar-color: #888 #F2F3F7;
      }
      .chat-messages::-webkit-scrollbar {
        width: 3px;
      }
      .chat-messages::-webkit-scrollbar-track {
        background-color: white;
      }
      .chat-messages::-webkit-scrollbar-thumb {
        background-color: #888;
        border-radius: 6px;
      }
      .chat-input-container{
        display: flex;
        flex-direction: column;
        row-gap: 10px;
        border-top: 1px solid var(--border-border-gray-200, #E5E7EB);
        border-top-width: 1px;
        border-color: rgba(229,231,235,1);
        padding: 16px;
        background: #FFF;
      }
      .chat-input-container-inner{
        display: flex;
        column-gap: 16px;
      }
      .chat-input{
        flex-grow: 1;
        background-color: #F2F3F7;
        border-radius: 8px;
        font-size: 14px;
        line-height: 20px;
        font-weight: 400;
        padding: 8px 44px;
        outline: none;
        border: none;
        resize: none;
        height: 36px;
        max-height: 136px;
        overflow-y: auto;
        word-break: break-word;
        scrollbar-width: thin;
        scrollbar-color: #888 #F2F3F7;
        user-select: none;
      }
      .chat-stack{
        display: flex;
        flex-direction: column;
        width: 100%;
      }
      .chat-popup .textarea-wrapper{
        display: flex;
        position: relative;
        flex-grow: 1;
      }
      .chat-popup .clip{
        position: absolute;
        bottom: 6px;
        left: 12px;
        min-width: 24px;
        width: 24px;
        max-width: 24px;
        min-height: 24px;
        height: 24px;
        max-height: 24px;
        background: none;
        border: none;
        cursor: pointer;
      }
      .chat-popup .record{
        position: absolute;
        bottom: 6px;
        right: 12px;
        min-width: 24px;
        width: 24px;
        max-width: 24px;
        min-height: 24px;
        height: 24px;
        max-height: 24px;
        background: none;
        border: none;
        cursor: pointer;
      }
      .chat-popup .record-wrapper{
        display: flex;
        align-items: center;
        flex-grow: 1;
      }
      .chat-popup .record-container{
        display: flex;
        align-items: center;
        flex-grow: 1;
        background-color: #F2F3F7;
        padding: 6px;
        max-width: 300px;
        border-radius: 8px;
        overflow: hidden;
        position:relative;
        height: 36px;
      }
      .chat-popup .road{
        display: flex;
        flex-direction: row-reverse;
        align-items: center;
        position: relative;
        column-gap: 2px;
        width: 100%;
        max-width: 177.5px;
        overflow: hidden;
        height: 24px;
        padding: 4px 0;
      }
      .chat-popup .road .elem{
        width: 2px;
        height: 2px;
        border-radius: 3px;
        background-color: #568BFC;
        min-height: 2px;
        max-height: 16px;
        display: flex;
        flex-shrink: 0;
        transition-property: opacity;
        transition-duration: .2s;
      }
      .chat-popup .chat-message-user-container .road .elem{
        background-color: #F0F7FF;
      }
      .chat-popup .road .elem.opacity{
        opacity: 0.4
      }
      .chat-popup .record-stop{
        min-width: 24px;
        width: 24px;
        max-width: 24px;
        min-height: 24px;
        height: 24px;
        max-height: 24px;
        background: none;
        border: none;
        cursor: pointer;
        margin-right: 8px;
      }
      .chat-submit-record{
        margin-left: 16px;
      }
      .chat-popup .clip > svg, .chat-popup .record > svg, .chat-popup .record-stop > svg{
        width: 100%;
        height: 100%;
      }
      .chat-popup .audio-play, .chat-popup .audio-stop, .chat-popup .audio-pause{
        display: flex;
        justify-content: center;
        align-items: center;
        width: 24px;
        max-width: 24px;
        min-width: 24px;
        height: 24px;
        max-height: 24px;
        min-height: 24px;
        background-color: #2963EE;
        border-radius: 50%;
        margin-right: 8px;
      }
      .audio-play > svg{
        width: 16px;
        height: 16px;
      }
      .timer{
        min-width: 39px;
        font-size: 14px;
        line-height: 20px;
        color: #192C3D80;
        margin-left: 8px;
      }
  
  
  
      .chat-input::-webkit-scrollbar {
        width: 3px;
      }
      .chat-input::-webkit-scrollbar-track {
        background-color: white;
      }
      .chat-input::-webkit-scrollbar-thumb {
        background-color: #888;
        border-radius: 6px;
      }
      .chat-submit{
        min-width: 36px !important;
        width: 36px !important;
        height: 36px !important;
        min-height: 36px !important;
        padding: 6px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        background-color: ${this.config?.send_button_color || 'gray'};
        border: none;
        align-self: flex-end;
        cursor: pointer;
      }
      .chat-submit svg{
        width: 24px;
        height: 24px;
        fill: white;
      }
      .chat-message-user{
        max-width: 80%;
        color: rgba(255,255,255,1);
        padding-top: 8px;
        padding-bottom: 8px;
        padding-left: 16px;
        padding-right: 16px;
        background-color: rgba(31,41,55,1);
        word-break: break-word;
        border-radius: 8px 8px 2px 8px;
        background-color: ${this.config?.user_message_color || 'gray'};
      }
      .chat-audio-message-user{
        display: flex;
        align-items: center;
        max-width: 80%;
        padding: 6px 0px 6px 12px;
        background-color: rgba(31,41,55,1);
        border-radius: 8px 8px 2px 8px;
        background-color: ${this.config?.user_message_color || 'gray'};
      }
      .chat-audio-message-user > .message-play-btn, .chat-audio-message-user > .message-pause-btn{
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        max-width: 40px;
        min-width: 40px;
        height: 40px;
        max-height: 40px;
        min-height: 40px;
        margin-right: 12px;
        background-color: #F0F7FF;
        border-radius: 50%;
        cursor: pointer;
        margin-bottom: 4px;
      }
      .chat-audio-message-user .message-audio-container{
        display: flex;
        flex-direction: column;
      }
      .message-audio-container .message-audio-duration{
        font-size: 12px;
        line-height: 16px;
        color: #fff;
        opacity: .6;
      }
      .message-audio-container .road{
        min-width: 177.5px;
      }
      .chat-message-user-container{
        display: flex;
        justify-content: flex-end;
        margin-bottom: 12px;
      }
      .chat-message-bot-container{
        display: flex;
        margin-bottom: 12px;
      }
      .chat-message-bot{
        max-width: 80%;
        color: rgba(0,0,0,1);
        padding-top: 8px;
        padding-bottom: 8px;
        padding-left: 16px;
        padding-right: 16px;
        background-color: rgba(229,231,235,1);
        word-break: break-word;
        border-radius: 8px 8px 8px 2px;
        background: #F2F3F7;
      }
      @media (max-width: 768px) {
        .chat-popup {
          position: fixed;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 100%;
          max-height: 100%;
          border-radius: 0;
          max-width: initial;
          min-width: initial;
        }
        .chat-header{
          border-radius: 0px;
        }
      }
      .chat-online{
        font-size: 14px;
        line-height: 20px;
        color: #fff;
      }
      @keyframes opacity-emergence{
        0%{
          opacity: 0;
        }
        100%{
          opacity: 1
        }
      }
      .chat-prints ~ .chat-online{
        display: none;
      }
      .chat-prints{
        display: flex;
        align-items: center;
        color: #fff;
      }
      .chat-prints-circle-container{
          display: flex;
          align-items: center;
          column-gap: 4px;
          margin-right: 5px;
      }
  
      .chat-prints-circle{
          min-width: 3px;
          width: 3px;
          max-width: 3px;
          height: 3px;
          max-height: 3px;
          min-height: 3px;
          border-radius: 50%;
          background-color: #fff;
      }
  
      .chat-prints-circle-first{
          animation-name: chat-prints-circle-first;
          animation-duration: 1.5s;
          animation-iteration-count: infinite;
      }
      .chat-prints-circle-second{
          animation-name: chat-prints-circle-second;
          animation-duration: 1.5s;
          animation-iteration-count: infinite;
      }
      .chat-prints-circle-third{
          animation-name: chat-prints-circle-third;
          animation-duration: 1.5s;
          animation-iteration-count: infinite;
      }
      .chat-lath{
        display: flex;
        align-items: center;
        align-self: center;
        column-gap: 4px;
        text-decoration: none;
      }
  
      .chat-lath-text{
        font-size: 12px;
        font-weight: 500;
        color: #A9ABBA;
        line-height: 16px;
      }
  
      @keyframes chat-prints-circle-first{
          0%{
              transform: scale(1);
          }
          16.5%{
              transform: scale(1.5);
          }
          33%{
              transform: scale(1);
          }
          100%{
              transform: scale(1);
          }
          
      }
      @keyframes chat-prints-circle-second{
          0%{
              transform: scale(1);
          }
          33%{
              transform: scale(1);
          }
          49.5%{
              transform: scale(1.5);
          }
          66%{
              transform: scale(1);
          }
          100%{
              transform: scale(1);
          }
      }
      @keyframes chat-prints-circle-third{
          0%{
              transform: scale(1);
          }
          66%{
              transform: scale(1);
          }
          80.5%{
              transform: scale(1.5);
          }
          99%{
              transform: scale(1);
          }
          100%{
              transform: scale(1);
          }
        }
        #close-popup svg path {
          stroke: #FFF;
        }
      `;
  
      document.head.appendChild(style);
  
      // Create chat widget container
      const chatWidgetContainer = document.createElement('div');
      chatWidgetContainer.id = 'chat-widget-container';
      chatWidgetContainer.classList.add('chat-widget-container')
      document.body.appendChild(chatWidgetContainer);
      
      // Inject the HTML
      chatWidgetContainer.innerHTML = `
        <div id="chat-bubble" class="chat-bubble">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
            <path d="M28.9467 47.6504C39.8283 45.3546 48 35.6374 48 23.9985C48 23.5096 47.9856 23.0241 47.9571 22.5424C47.863 23.2354 47.7271 23.9192 47.5483 24.5888C45.6352 31.5183 39.6418 37.3533 33.0557 40.1203C30.3006 41.2657 27.3378 41.9074 24.3574 41.8351C22.5851 41.8048 20.8193 41.486 19.1253 40.9874C13.4123 39.3954 8.85917 35.1162 7.72156 29.256C7.01644 25.8175 7.46243 22.2029 9.21993 19.115C12.8961 12.5059 20.8174 8.18246 28.4957 9.62973C29.8207 9.85743 31.1328 10.2395 32.4238 10.7261C31.2931 9.94074 30.0561 9.28084 28.7421 8.76759C19.1946 4.99007 6.8639 11.7986 2.80201 20.8217C0.748435 25.489 0.750206 29.4275 2.6052 34.1583C5.54037 41.7517 13.9216 46.8197 21.8565 47.8244C24.2407 48.1133 26.6228 48.0391 28.9467 47.6504Z" fill="white"/>
            <path d="M18.2828 0.522731C20.8994 -0.0127422 23.6003 -0.15204 26.304 0.17563C34.2389 1.18032 42.6201 6.24833 45.5553 13.8417C47.4103 18.5725 47.4121 22.511 45.3585 27.1783C41.2966 36.2014 28.9659 43.0099 19.4184 39.2324C18.1044 38.7192 16.8674 38.0592 15.7367 37.2739C17.0277 37.7605 18.3399 38.1426 19.6648 38.3703C27.3431 39.8175 35.2644 35.494 38.9406 28.8849C40.6981 25.7971 41.1441 22.1825 40.4389 18.744C39.3013 12.8837 34.7482 8.6046 29.0352 7.01258C27.3412 6.51402 25.5754 6.19519 23.8031 6.16485C20.8227 6.09256 17.8599 6.73432 15.1048 7.8797C8.5187 10.6467 2.52536 16.4817 0.61222 23.4112C0.36021 24.3548 0.193617 25.3265 0.108591 26.3124C0.036746 25.5509 0 24.779 0 23.9985C0 12.636 7.78824 3.10505 18.2828 0.522731Z" fill="white"/>
            <path d="M20.6106 23.2427C20.6252 23.2045 20.6332 23.1714 20.6339 23.1418C20.6346 23.1173 20.6077 23.1022 20.5866 23.1152C19.6913 23.6858 18.5157 24.0972 17.4705 23.9661C15.5888 23.7298 14.3026 21.7383 15.4207 20.03C15.4928 19.9197 15.6711 19.7079 15.9557 19.3945C16.506 18.7871 16.8663 18.2266 17.0759 17.4355C17.2616 16.7344 17.4362 16.1306 17.6008 15.6227C18.3738 13.2364 20.3187 11.6505 22.8554 11.4027C25.3798 11.1563 27.8656 12.147 29.3847 14.15C30.2356 15.2718 30.5202 16.5291 30.24 17.9225C30.1976 18.1319 30.1265 18.3749 30.0534 18.6251C29.9947 18.8261 29.9346 19.0317 29.8869 19.2281C29.7493 19.798 30.24 20.5286 30.561 21.0012C30.6796 21.1749 30.7407 21.3103 30.7451 21.4069C30.7625 21.7415 30.2616 21.87 29.9437 21.9515C29.9016 21.9623 29.8627 21.9723 29.8287 21.9818C29.7741 21.9969 29.7413 22.051 29.7537 22.1057C29.801 22.319 29.8571 22.5229 29.9211 22.7182C29.943 22.7852 29.9117 22.8471 29.828 22.9033C29.7312 22.9689 29.6387 23.0294 29.5514 23.0849C29.5193 23.1051 29.5121 23.1483 29.5361 23.1779C29.7178 23.398 29.5142 23.5933 29.3493 23.7514C29.3134 23.7859 29.2793 23.8186 29.2515 23.8494C29.2362 23.8659 29.226 23.8875 29.2224 23.9106C29.2115 23.9797 29.2042 24.0527 29.1968 24.1258C29.1824 24.2691 29.168 24.4131 29.127 24.531C28.9421 25.0605 28.5374 25.3285 27.9129 25.335C27.0911 25.3444 26.3836 25.2032 25.6134 25.0324C25.3041 24.9633 25.0835 24.9424 24.9503 24.969C24.4415 25.0713 24.1329 25.6679 23.9378 26.0808C23.5251 26.9547 23.2492 27.8222 23.1109 28.6818C23.028 29.1969 23.183 29.6379 23.5753 30.0046C24.2785 30.661 24.9518 31.3455 25.5945 32.058C26.5444 33.1114 27.4521 34.6345 27.4514 36.0986C27.4514 36.1231 27.4354 36.1447 27.4121 36.1519C27.3036 36.1872 27.1369 36.2305 26.9127 36.2809C25.7838 36.5338 24.681 36.6786 23.603 36.7139C19.0988 36.8602 14.767 35.4833 11.8496 31.942C11.8038 31.8866 11.7659 31.8008 11.7354 31.6834C11.7295 31.661 11.731 31.6387 11.7397 31.6171C12.2704 30.3159 13.0783 29.2423 14.1636 28.3972C14.4373 28.1839 14.8457 27.9267 15.3894 27.6248C15.6272 27.4928 15.852 27.3695 16.0666 27.2518C17.1569 26.6536 17.9837 26.2 18.9081 25.4957C19.6876 24.902 20.2547 24.1512 20.6106 23.2427Z" fill="white"/>
          </svg>
          <div id="chat-unread-message-icon" class="chat-unread-message-icon hidden"></div>
        </div>
        <div id="chat-popup" class="chat-popup hidden ">
        <div id="chat-header" class="chat-header">
            <div>
              <h3>${this.config.chat_title}</h3>
              <div class="chat-status">
                <div class="chat-online">Онлайн</div>
              </div>
              
            </div>
            <button id="close-popup">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="chat-messages" class="chat-messages">
            <div id="chat-history" class="chat-history"></div>
          </div>
          <div id="chat-input-container" class="chat-input-container">
            <div id="chat-input-container-inner" class="chat-input-container-inner">
              <div class="chat-stack">
                <div class="textarea-wrapper">
                  <button class="clip">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M11.4699 3.46963C12.4062 2.53333 13.6761 2.00732 15.0002 2.00732C16.3243 2.00732 17.5942 2.53333 18.5305 3.46963C19.4668 4.40594 19.9928 5.67583 19.9928 6.99996C19.9928 8.3241 19.4668 9.59399 18.5305 10.5303L12.0305 17.0303C11.492 17.5688 10.7617 17.8713 10.0002 17.8713C9.23867 17.8713 8.50834 17.5688 7.96986 17.0303C7.43139 16.4918 7.12887 15.7615 7.12887 15C7.12887 14.2384 7.43139 13.5081 7.96986 12.9696L14.4699 6.46963C14.7628 6.17674 15.2376 6.17674 15.5305 6.46963C15.8234 6.76253 15.8234 7.2374 15.5305 7.53029L9.03052 14.0303C8.77335 14.2875 8.62887 14.6363 8.62887 15C8.62887 15.3637 8.77335 15.7125 9.03052 15.9696C9.28769 16.2268 9.6365 16.3713 10.0002 16.3713C10.3639 16.3713 10.7127 16.2268 10.9699 15.9696L17.4699 9.46963C18.1249 8.81464 18.4928 7.92627 18.4928 6.99996C18.4928 6.07366 18.1249 5.18529 17.4699 4.53029C16.8149 3.8753 15.9265 3.50732 15.0002 3.50732C14.0739 3.50732 13.1855 3.8753 12.5305 4.53029L6.03052 11.0303C4.9777 12.0831 4.38623 13.511 4.38623 15C4.38623 16.4889 4.9777 17.9168 6.03052 18.9696C7.08334 20.0225 8.51128 20.6139 10.0002 20.6139C11.4891 20.6139 12.917 20.0225 13.9699 18.9696L20.4699 12.4696C20.7628 12.1767 21.2376 12.1767 21.5305 12.4696C21.8234 12.7625 21.8234 13.2374 21.5305 13.5303L15.0305 20.0303C13.6964 21.3644 11.8869 22.1139 10.0002 22.1139C8.11345 22.1139 6.30399 21.3644 4.96986 20.0303C3.63573 18.6962 2.88623 16.8867 2.88623 15C2.88623 13.1132 3.63573 11.3038 4.96986 9.96963L11.4699 3.46963Z" fill="#9C9EAD"/>
                    </svg>
                  </button>
                  <textarea id="chat-input" class="chat-input" placeholder="Написать сообщение..."></textarea>
                  <button id="record-start" class="record">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M7.25021 6C7.25021 3.37665 9.37686 1.25 12.0002 1.25C14.6236 1.25 16.7502 3.37665 16.7502 6V10C16.7502 12.6234 14.6236 14.75 12.0002 14.75C9.37686 14.75 7.25021 12.6234 7.25021 10V6ZM12.0002 2.75C10.2053 2.75 8.75021 4.20507 8.75021 6V10C8.75021 11.7949 10.2053 13.25 12.0002 13.25C13.7951 13.25 15.2502 11.7949 15.2502 10V6C15.2502 4.20507 13.7951 2.75 12.0002 2.75ZM4.69489 13.3508C5.05344 13.1434 5.51223 13.2659 5.71964 13.6244C6.97433 15.7934 9.3176 17.25 12.0002 17.25C14.6828 17.25 17.026 15.7934 18.2807 13.6244C18.4881 13.2659 18.9469 13.1434 19.3055 13.3508C19.664 13.5582 19.7865 14.017 19.5791 14.3755C18.1852 16.7851 15.6729 18.4701 12.7502 18.7183L12.7502 21C12.7502 21.4142 12.4144 21.75 12.0002 21.75C11.586 21.75 11.2502 21.4142 11.2502 21L11.2502 18.7183C8.32749 18.4701 5.81512 16.7851 4.42123 14.3755C4.21383 14.017 4.33635 13.5582 4.69489 13.3508Z" fill="#9C9EAD"/>
                    </svg>
                  </button>
                </div>
              </div>
              <button id="chat-submit" class="chat-submit">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M12 5V19M12 5L18 11M12 5L6 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div id="record-wrapper" class="record-wrapper hidden">
              <button id="record-stop" class="record-stop">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M18 6L6 18M6 6L18 18" stroke="#9C9EAD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="record-container">
                <div id="audio-play" class="audio-play hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="white"><g><path d="M26.78,13.45,11.58,4A3,3,0,0,0,7,6.59V25.41a3,3,0,0,0,3,3A3,3,0,0,0,11.58,28l15.2-9.41a3,3,0,0,0,0-5.1Z"/></g></svg>
                </div>
                <div id="audio-pause" class="audio-pause hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 32 32" width="16" fill="white"><defs><style>.cls-1{fill:none;}</style></defs><title/><path d="M12,6H10A2,2,0,0,0,8,8V24a2,2,0,0,0,2,2h2a2,2,0,0,0,2-2V8a2,2,0,0,0-2-2Z"/><path d="M22,6H20a2,2,0,0,0-2,2V24a2,2,0,0,0,2,2h2a2,2,0,0,0,2-2V8a2,2,0,0,0-2-2Z"/><rect class="cls-1" data-name="&lt;Transparent Rectangle&gt;" height="32" id="_Transparent_Rectangle_" width="32"/></svg>
                </div>
                <div id="audio-stop" class="audio-stop">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4.5 13.5C3.39543 13.5 2.5 12.6046 2.5 11.5V4.5C2.5 3.39543 3.39543 2.5 4.5 2.5H11.5C12.6046 2.5 13.5 3.39543 13.5 4.5V11.5C13.5 12.6046 12.6046 13.5 11.5 13.5H4.5Z" fill="white"/>
                  </svg>
                </div>
                <div id="record-road" class="road"></div>
                <div id="timer" class="timer">00:00</div>
              </div>
              <button id="chat-submit-record" class="chat-submit chat-submit-record">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M12 5V19M12 5L18 11M12 5L6 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </button>
            </div>
            <a href="https://maia.work/" class="chat-lath" target="_blank">
              <div class="chat-lath-text">Работает на</div>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17" fill="none">
                <path d="M9.64983 15.9697C13.2766 15.2041 16 11.9653 16 8.08598C16 7.923 15.9952 7.76115 15.9857 7.60056C15.9543 7.83156 15.909 8.05948 15.8494 8.28268C15.2117 10.5925 13.2139 12.5375 11.0186 13.4599C10.1002 13.8416 9.1126 14.0556 8.11912 14.0315C7.52838 14.0214 6.93978 13.9151 6.37509 13.7489C4.47078 13.2182 2.95306 11.7918 2.57385 9.83843C2.33881 8.69225 2.48747 7.4874 3.07331 6.45811C4.29869 4.25507 6.93915 2.81391 9.49857 3.29634C9.94022 3.37224 10.3776 3.49958 10.8079 3.66179C10.431 3.40001 10.0187 3.18004 9.58071 3.00896C6.39819 1.74978 2.28797 4.01929 0.934004 7.02699C0.249478 8.58277 0.250069 9.89558 0.868401 11.4725C1.84679 14.0036 4.64054 15.693 7.28551 16.0279C8.08055 16.1242 8.87488 16.0994 9.64983 15.9697Z" fill="#A9ABBA"/>
                <path d="M6.09525 0.260467C6.96715 0.082143 7.86711 0.0357871 8.76799 0.144969C11.413 0.479865 14.2067 2.1692 15.1851 4.70033C15.8034 6.27727 15.804 7.59007 15.1195 9.14586C13.7655 12.1536 9.65531 14.4231 6.47279 13.1639C6.0348 12.9928 5.62248 12.7728 5.24557 12.5111C5.67589 12.6733 6.11328 12.8006 6.55493 12.8765C9.11435 13.3589 11.7548 11.9178 12.9802 9.71474C13.566 8.68544 13.7147 7.48059 13.4796 6.33442C13.1004 4.38101 11.5827 2.95463 9.67841 2.42395C9.11372 2.25777 8.52512 2.15149 7.93438 2.14138C6.9409 2.11728 5.95329 2.3312 5.03493 2.71299C2.83957 3.63531 0.841786 5.58032 0.204073 7.89017C0.120068 8.20469 0.0645366 8.5286 0.0361951 8.85724C0.012248 8.60341 0 8.34613 0 8.08598C0 4.29811 2.59657 1.12089 6.09525 0.260467Z" fill="#A9ABBA"/>
                <path d="M6.8702 7.83399C6.87505 7.82126 6.87772 7.81021 6.87796 7.80037C6.87821 7.7922 6.86923 7.78716 6.86219 7.79148C6.56376 7.98169 6.1719 8.11883 5.82348 8.07512C5.19628 7.99634 4.76755 7.33252 5.14023 6.76308C5.16425 6.72634 5.2237 6.65573 5.31857 6.55126C5.502 6.3488 5.6221 6.16195 5.69198 5.89824C5.75385 5.66456 5.81208 5.4633 5.86692 5.29398C6.12459 4.49855 6.7729 3.96994 7.61848 3.88732C8.45993 3.80519 9.28852 4.13542 9.79489 4.80308C10.0785 5.17702 10.1734 5.59611 10.08 6.0606C10.0659 6.13038 10.0422 6.21139 10.0178 6.29478C9.99823 6.36176 9.97819 6.43031 9.96231 6.49578C9.91645 6.68575 10.08 6.92928 10.187 7.08683C10.2265 7.14471 10.2469 7.18986 10.2484 7.22204C10.2542 7.3336 10.0872 7.37642 9.98124 7.4036C9.96721 7.4072 9.95425 7.41052 9.94289 7.4137C9.9247 7.41874 9.91378 7.43675 9.91791 7.45501C9.93368 7.5261 9.95236 7.59406 9.97371 7.65915C9.98099 7.68148 9.97055 7.70214 9.94265 7.72087C9.91038 7.74273 9.87957 7.7629 9.85045 7.78139C9.83978 7.78812 9.83735 7.80253 9.84536 7.81238C9.90593 7.88574 9.83806 7.95085 9.7831 8.00357C9.77113 8.01505 9.75977 8.02595 9.75049 8.03621C9.74539 8.04173 9.742 8.04894 9.74078 8.05662C9.73718 8.07967 9.73473 8.10398 9.73228 8.12835C9.72748 8.17611 9.72265 8.22414 9.709 8.26341C9.64737 8.43993 9.51246 8.52927 9.30429 8.53143C9.03035 8.53456 8.79452 8.48748 8.53781 8.43056C8.43469 8.40751 8.36117 8.40054 8.31677 8.40943C8.14717 8.44353 8.0443 8.64239 7.97927 8.78001C7.8417 9.07133 7.74974 9.36049 7.70364 9.64701C7.67598 9.81873 7.72766 9.96571 7.85844 10.088C8.09282 10.3068 8.31726 10.5349 8.5315 10.7724C8.84814 11.1236 9.1507 11.6313 9.15046 12.1193C9.15046 12.1275 9.14512 12.1347 9.13736 12.1371C9.1012 12.1488 9.04564 12.1632 8.97091 12.1801C8.59459 12.2644 8.227 12.3126 7.86766 12.3244C6.36625 12.3731 4.92235 11.9142 3.94988 10.7338C3.93459 10.7153 3.92197 10.6867 3.91178 10.6475C3.90984 10.6401 3.91033 10.6327 3.91324 10.6255C4.09012 10.1917 4.35944 9.83386 4.72121 9.55215C4.81244 9.48106 4.94855 9.39532 5.1298 9.29469C5.20911 9.25067 5.2841 9.20953 5.35566 9.17027C5.71912 8.97087 5.99456 8.81976 6.30268 8.58499C6.56254 8.3871 6.75155 8.13684 6.8702 7.83399Z" fill="#A9ABBA"/>
              </svg>
              <div class="chat-lath-text">MAIA</div>
            </a>
          </div>
        </div>
      `;
      this.elementSearch()
    },
    this.elementSearch = ()=>{
      this.chatInput = document.getElementById('chat-input')
      this.chatSubmit = document.getElementById('chat-submit')
      this.chatMessages = document.getElementById('chat-messages')
      this.chatBubble = document.getElementById('chat-bubble')
      this.chatPopup = document.getElementById('chat-popup')
      this.closePopup = document.getElementById('close-popup')
      this.chatHistory = document.getElementById('chat-history')
      this.chatInputContainerInner = document.getElementById('chat-input-container-inner')
      this.recordWrapper = document.getElementById('record-wrapper')
      this.recordRoad = document.getElementById('record-road')
      this.recordStart = document.getElementById('record-start')
      this.recordStop = document.getElementById('record-stop')
      this.audioPlay = document.getElementById('audio-play')
      this.audioPause = document.getElementById('audio-pause')
      this.audioStop = document.getElementById('audio-stop')
      this.timer = document.getElementById('timer')
      this.chatSubmitRecord = document.getElementById('chat-submit-record')
    },
    this.autoSizeWidth = ()=>{
      if(window.innerWidth < 768){ return }
      if(this.chatMessages.clientHeight < this.chatMessages.scrollHeight){
        this.chatMessages.style.paddingRight = '13px';
      }
    },
    this.messagesContainerCheckWidth = ()=>{
      if(window.innerWidth > 768 && this.chatMessages.clientHeight < this.chatMessages.scrollHeight){ 
        this.chatMessages.style.paddingRight = '13px';
      } else {
        this.chatMessages.style.paddingRight = '16px';
      }
    },
    this.resizeChatWidth = ()=>{
      window.addEventListener('resize', () => {
        this.messagesContainerCheckWidth()
      })
    },
    this.textareaCheckHeight = ()=>{
      this.chatInput.style.height = "36px"
      this.chatInput.style.height = this.chatInput.scrollHeight + 'px'; 
    },
    this.textareaAutoHeight = ()=>{
      this.chatInput.addEventListener('input', ()=>{
        this.textareaCheckHeight()
      })
    },
    this.sendingToChat = ()=>{
      this.chatSubmit.addEventListener('click', async () => {
        const message = this.chatInput.value.trim();
        if (!message) return;
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
  
        this.onUserRequest(message);
        
        globalThis.prints.printsAdd()
        
        this.autoSizeWidth()
        this.textareaCheckHeight()
      });
    },
    this.sendingUsingEnter = ()=>{
      this.chatInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
          this.chatSubmit.click();
          this.autoSizeWidth()
        }
      });
    },
    this.textareaCancelNewlineOn = ()=>{
      this.chatInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault()
        }
      })
    },
    this.openChat = ()=>{
      this.chatBubble.addEventListener('click', () => {
        this.togglePopup();
      });
    },
    this.closeChat = ()=>{
      this.closePopup.addEventListener('click', () => {
        this.togglePopup();
      });
    },
    this.togglePopup = ()=>{
      this.chatPopup.classList.toggle('hidden');
    },
    this.scrollWindowToBottom = ()=>{
      this.chatPopup.classList.remove('hidden')
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight
      this.chatPopup.classList.add('hidden')
    },
  
    this.chatAutoStart = {
      init(){
        this.setTimeoutAutoStart()
      },
      setTimeoutAutoStart(){
        if(globalThis.config?.seconds_to_autostart){
          setTimeout(()=>{
            if(globalThis.checkFirstOpening.isOpened) return
            if(globalThis.chatPopup.classList.contains('hidden')){
              globalThis.chatBubble.click()
            }
          }, globalThis.config?.seconds_to_autostart * 1000)
        }
      }
    }
  
    this.userMessageAppend = (message)=>{
        const messageElement = this.getUserMessage(message)
        this.chatMessages.appendChild(messageElement);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        this.chatInput.value = '';
    },
  
    this.onUserRequest = (message)=>{
      try{
        this.userMessageAppend(message);
        
        this.ws.send(JSON.stringify({
          "action": "MESSAGE", 
          "session_id": localStorage.getItem('session_id'),
          message
        }))
  
      } catch(e){
        console.log(e)
      }
    },
    this.getBotMessage = (message)=>{
      const parseMessage = globalThis.convertingFunction.parseLinks(message) 
      const bMessage = document.createElement('div')
      bMessage.className = 'flex mb-3 chat-message-bot-container';
      bMessage.innerHTML = `<div class="chat-message-bot">${parseMessage}</div>`;
      return bMessage
    },
    this.getUserMessage = (message)=>{
      const uMessage = document.createElement('div');
      uMessage.className = 'chat-message-user-container';
      uMessage.innerHTML = `<div class="chat-message-user">${message}</div>`;
      return uMessage
    },
    this.loadMessageHistory = ()=>{
      this.config.conversation_history.forEach(({author, message}) => {
        this.chatHistory.append(author === 'USER'  ? this.getUserMessage(message) : this.getBotMessage(message))
      })
      this.scrollWindowToBottom()
    },
    this.reply = (message)=>{
      this.messageSound.audioPlay()
      const replyElement = this.getBotMessage(message)
      this.chatMessages.appendChild(replyElement);
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      this.autoSizeWidth()
    },
  
    this.openWebSoket = (domain='apidev.maia.work') => {
      const {appId, apiHash} = document.querySelector('#maia-chat-widget').dataset
      this.ws = new WebSocket(`wss://${domain}/api/v1/webhook/chat_widget?app_id=${appId}&api_hash=${apiHash}`)
      this.webSocketOpenHandler()
      this.webSocketMessageHandler()    
      this.webSocketCloseHandler()
      this.websocketClosure()
    },
    this.webSocketOpenHandler = ()=>{
      this.ws.onopen = (e)=>{
        this.ws.send(JSON.stringify({
          "action": "INIT",
          "session_id": localStorage.getItem('session_id') ? localStorage.getItem('session_id') : undefined,
        }))
      }
    },
    this.webSocketMessageHandler = ()=>{
      this.ws.onmessage = (e)=>{
        const response = JSON.parse(JSON.parse(e.data))
        if(response.action === 'INIT'){
  
          if(localStorage.getItem('session_id')){
          } else {
            localStorage.setItem('session_id', response.session_id)
          }
          this.writingDataToConfig(response)
          
          // if(!this.checkDomen()) return false
          this.init()
          this.messageSound.init()
          this.iconForUnreadMessage.init()
        }
  
        if(response.action === 'MESSAGE'){
          this.reply(response.answer)
          this.iconForUnreadMessage.messageCheck()
          globalThis.prints.printsRemove()
        }
      }
    },
    this.webSocketCloseHandler = ()=>{
      this.ws.onclose = (e)=>{
        this?.chatInput?.setAttribute('disabled', true)
      }
    },
    this.websocketClosure = () => {
      document.addEventListener('unload', ()=>{
        this.ws.close()
      })
    }
    this.writingDataToConfig = (rspns)=>{
      this.config = {
        ...this.config,
        salesperson_name: rspns.salesperson_name,
        salesperson_role: rspns.salesperson_role,
        chat_title: rspns.chat_title,
        circle_color: rspns.circle_color,
        header_color: rspns.header_color,
        seconds_to_autostart: rspns.seconds_to_autostart,
        send_button_color: rspns.send_button_color,
        user_message_color: rspns.user_message_color,
        widget_location: rspns.widget_location,
        conversation_history: rspns.conversation_history,
        allowed_domains: rspns.allowed_domains
      }
    },
    this.checkDomen = ()=>{
      const currentHref = window.location.href
      if(currentHref.includes(this.config.allowed_domains[0])){
        return true
      } else {
        console.log('Ваш домен не включен в список доступных доменов')
        return false
      }
    }
  
    this.prints = {
      callArray: [],
      printsLoadingChoiceActionStart(){
        this.callArray.push(true)
        if(this.callArray.length === 1){
            this.printsAdd()
        }
      },
      printsLoadingChoiceActionFinish(){
        if(this.callArray.length === 1){
            this.printsRemove()
        }
        this.callArray.pop()
    },
      printsAdd(){
        const printsContainer = document.querySelector('.chat-status')
        if(printsContainer.querySelector('[data-chat-prints-loading]')) return
        printsContainer.prepend(this.getPrintsHTML())
      },
      printsRemove(){
        const printsContainer = document.querySelector('.chat-status [data-chat-prints-loading]')
        printsContainer?.remove()
      },
      getPrintsHTML(){
        const prints = document.createElement('div')
        prints.innerHTML = `<div class="chat-prints" data-chat-prints-loading>
                                        <div class="chat-prints-circle-container">
                                          <div class="chat-prints-circle chat-prints-circle-first"></div>
                                            <div class="chat-prints-circle chat-prints-circle-second"></div>
                                              <div class="chat-prints-circle chat-prints-circle-third"></div>
                                            </div>
                                            печатает
                                        </div>`
        return prints.firstElementChild
      }
    }
  
    this.messageSound = {
      init(){
        this.createAudio()
      },
      createAudio(){
        this.sound = document.createElement('audio')
        this.sound.src = `https://b6905acf-5120-4e0c-b3ea-3716bba15c68.selstorage.ru/message_sound.mp3`
        this.sound.addEventListener('error', ()=>{
          this.sound = null
        })
      },
      audioPlay(){
        if(!this.sound) return
        if(!this.sound.paused){
          this.sound.pause()
          this.sound.currentTime = 0;
        }
        this.sound.play()
      }
    }
  
    this.iconForUnreadMessage = {
      init(){
        this.chatOpenHandler()
      },
      messageCheck(){
        if(!this.closeСheck()) return
        this.showIcon()
        this.setNotifLocaleStorage()
      },
      closeСheck(){
        const chat = document.querySelector('#chat-popup')
        if(!chat) return
        return chat.classList.contains('hidden') 
      },
      showIcon(){
        const icon = document.querySelector('#chat-unread-message-icon')
        if(!icon) return
        icon.classList.remove('hidden')
      },
      setNotifLocaleStorage(){
        localStorage.setItem('unred-message', true)
      },
      removeNotifLocaleStorage(){
        localStorage.removeItem('unred-message')
      },
      checkNotifLocaleStorage(){
        if(localStorage.getItem('unred-message')){
          this.showIcon()
        }
      },
      hiddenIcon(){
        const icon = document.querySelector('#chat-unread-message-icon')
        if(!icon) return
        icon.classList.add('hidden')
      },
      chatOpenHandler(){
        const btnOpen = document.querySelector('#chat-bubble')
        if(!btnOpen) return
        btnOpen.addEventListener('click', ()=>{
          if(!this.closeСheck()){
            this.hiddenIcon()
            this.removeNotifLocaleStorage()
          } 
        })
      }
    }
  
    this.insertMetaTag = () => {
      let meta = document.querySelector('meta[name="viewport"]');
      if(!meta){
        meta = document.createElement('meta');
        meta.name = 'viewport';
        document.getElementsByTagName('head')[0].appendChild(meta);
      }
      if(meta.content){
        if(!meta.content.includes(', user-scalable=no')){
          meta.content += ', user-scalable=no';
        } else {
          meta.content = "width=device-width, initial-scale=1.0, user-scalable=no";
        }
      }
    }
  
    this.record = {
      init() {
        this.setHandlers();
      },
  
      stream: null,
      mainMedia: null,
      chunks: [],
      stepMS: 200,
      isRecording: false,
      isPaused: false,
      volumeArrayCurrentAudio: [],
      resizedArraySound: [],
      audioObject: new Audio(),
      timerMS: 0,
      timerId: null,
      maxElemsInRoad: 45,
      audioDuration: 0,
      paintingTimer: null,
  
      setHandlers(){
        this.startRecordHandler()
        this.closeRecordHandler()
        this.stopRecordHandler()
        this.playAudioHandler()
        this.pauseAudioHandler()
        this.submitAudioMessageHandler()
      },
  
      startRecordHandler(){
        globalThis.recordStart.addEventListener('click', () => {
          this.startRecord()
        })
      },
  
      closeRecordHandler(){
        globalThis.recordStop.addEventListener('click', () => {
          this.closeRecord()
        })
      },
  
      stopRecordHandler(){
        globalThis.audioStop.addEventListener('click', () => {
          this.stopRecord()
        })
      },
  
      playAudioHandler(){
        globalThis.audioPlay.addEventListener('click', () => {
          this.playAudio()
        })
      },
  
      pauseAudioHandler(){
        globalThis.audioPause.addEventListener('click', () => {
          this.pauseAudio()
        })
      },
  
      submitAudioMessageHandler() {
        globalThis.chatSubmitRecord.addEventListener('click', () => {
          this.submitAudioMessage()
        })
      },
  
      async startRecord(){
        try{
          const helpers = this.helpers
          if(!this.stream){
            this.stream = await navigator.mediaDevices.getUserMedia({audio: true})
          }
          
          if(this.stream){
            this.isRecording = true
  
            helpers.clearRecordRoad()
            helpers.hideChatInputContainerInner()
            helpers.visibleRecordWrapper()
            helpers.clearTimerContainer()
            helpers.visibleAudioStop()
            helpers.hideAudioPlay()
            helpers.hideAudioPause()
            this.resetAllVoices()
            this.clearAudioObject()
  
            this.chunks = [];
            this.mainMedia = new MediaRecorder(this.stream);
            
            this.mainMedia.ondataavailable = (e) => {
                this.chunks.push(e.data)
            }
            this.mainMedia.onstop = () => {
                clearInterval(timerSmallPart)
                this.stopTimer()
            }
  
            this.mainMedia.start()
            this.startTimer(0)
  
            this.mediaStart()
            const timerSmallPart = setInterval(() => this.mediaStart(), (this.stepMS * 2))
          }
        } catch (error) {
          console.error('CHAT-WIDGET: Error: ', error);
        }
      },
  
      closeRecord(){
        if(!this.mainMedia) return
        const helpers = this.helpers
  
        this.mainMedia.stop()
        
        this.clearAudioObject()
  
        this.pausePaintingElems()
        this.stopTimer()
        this.clearState()
        this.resetAllVoices()
  
        helpers.hideRecordWrapper()
        helpers.visibleChatInputContainerInner()
        helpers.hideAudioPlay()
        helpers.hideAudioPause()
        helpers.visibleAudioStop()
      },
  
      stopRecord(){
        if(!this.mainMedia) return
        const helpers = this.helpers
  
        this.isRecording = false;
        this.mainMedia.stop()
        this.createResultAudioTrack()
        helpers.hideAudioStop()
        helpers.visibleAudioPlay()
  
      },
  
      playAudio() {
        const helpers = this.helpers
        
        
        this.resetAllVoices()
  
        if (!this.isPaused) {
          this.clearAudioObject()
  
          const blob = new Blob(this.chunks)
  
          const audioContext = new AudioContext()
          blob.arrayBuffer().then((arrayBuffer) => {
            audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                this.audioDuration = audioBuffer.duration
  
                this.audioObject.src = URL.createObjectURL(blob);
                this.audioObject.load();
                
                this.audioObject.oncanplaythrough = () => {
                  this.audioObject.oncanplaythrough = null
                  this.audioObject.play()
                  this.startTimer()
                  this.startPaintingElems()
            
                  helpers.clearTimerContainer()
                  helpers.hideAudioPlay()
                  helpers.visibleAudioPause()
                }
  
                this.audioObject.onended = () => {
                  this.audioObject.onended = null
  
                  URL.revokeObjectURL(this.audioObject.src)
  
                  helpers.visibleAudioPlay()
                  helpers.hideAudioPause()
  
                  this.stopTimer()
                  this.audioObject.currentTime = 0
                  this.isPaused = false
                  
                  helpers.transparencyElems()
                }
            })
        })
  
        } else {
          this.isPaused = false
          helpers.hideAudioPlay()
          helpers.visibleAudioPause()
          this.startTimer(this.timerMS)
          this.startPaintingElems()
          this.audioObject.play()
        }
      },
  
      pauseAudio(){
        const helpers = this.helpers
        this.isPaused = true
        this.audioObject.pause()
        this.pauseTimer()
        this.pausePaintingElems()
        helpers.hideAudioPause()
        helpers.visibleAudioPlay()
      },
  
      mediaStart() {
        const media = new MediaRecorder(this.stream);
    
        media.ondataavailable = (e) => {
            media.stop()
            this.getMaxVolumeFromBlob(e.data).then((volume) => { 
              if(this.isRecording){
                this.insert(volume)
                this.volumeArrayCurrentAudio.push(volume)
              }
            })
        }
  
        media.start()
  
        setTimeout(() => media.stop(), this.stepMS)
      },
  
      clearAudioObject() {
        this.audioObject.pause()
        this.audioObject.src = ''
        URL.revokeObjectURL(this.audioObject.src)
      },
  
      getMaxVolumeFromBlob(blob) {
        return new Promise((resolve, reject) => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)()
    
            const reader = new FileReader()
            reader.onloadend = () => {
                const arrayBuffer = reader.result
    
                audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                    const source = audioContext.createBufferSource()
                    source.buffer = audioBuffer
    
                    const analyser = audioContext.createAnalyser()
                    source.connect(analyser)
    
                    analyser.fftSize = 256
                    const bufferLength = analyser.frequencyBinCount
                    const dataArray = new Uint8Array(bufferLength)
    
                    let maxVolume = 0
    
                    function getVolume() {
                        analyser.getByteFrequencyData(dataArray)
    
                        let sum = 0
  
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i]
                        }
  
                        const average = sum / bufferLength
    
                        if (average > maxVolume) {
                            maxVolume = average
                        }
                    }
    
                    source.start()
                    const interval = setInterval(() => {
                        getVolume()
                    }, 100)
    
                    setTimeout(() => {
                        clearInterval(interval)
                        audioContext.close()
                        resolve(maxVolume > 100 ? 100 : parseInt(maxVolume))
                    }, 1000);
                }, (error) => {
                    reject(error)
                });
            };
    
            reader.readAsArrayBuffer(blob)
        });
      },
    
      insert (volume, className = []) {
        const elem = document.createElement('div')
        elem.innerHTML = `<div class="elem ${className.join(' ')}" style="height: ${this.getHeight(volume)}px"></div>`
        globalThis.recordRoad.prepend(elem.firstElementChild)
      },
  
      getHeight(volume) {
        m = (16 - 2) / (100 - 0)
        b = m * 0 + 2
        return m * volume + b
      },
  
      startTimer(timer) {
        timer = this.timerMS ? this.timerMS : 0
        this.timerId = setInterval(() => {
            if (timer >= 180 * 100) {
              globalThis.audioStop.click()
              clearInterval(this.timerId)
            }
    
            let totalSeconds = Math.floor(timer / 100)
            let minutes = Math.floor(totalSeconds / 60)
            let seconds = totalSeconds % 60
    
            minutes = minutes < 10 ? '0' + minutes : minutes
            seconds = seconds < 10 ? '0' + seconds : seconds
    
            globalThis.timer.textContent = `${minutes}:${seconds}`
            
            timer++
            this.timerMS = timer
        }, 10)
      },
  
      pauseTimer() {
        clearInterval(this.timerId)
      },
  
      stopTimer() {
        this.timerMS = 0;
        clearInterval(this.timerId)
      },
  
      setNormalizeDurationAudio(){
            let totalSeconds = Math.floor(this.audioDuration)
            let minutes = Math.floor(totalSeconds / 60)
            let seconds = totalSeconds % 60
    
            minutes = minutes < 10 ? '0' + minutes : minutes
            seconds = seconds < 10 ? '0' + seconds : seconds
    
            globalThis.timer.textContent = `${minutes}:${seconds}`
      },
  
      createResultAudioTrack() {
        const helpers = this.helpers
        helpers.clearRecordRoad()
  
        this.resizedArrayAudio = this.resizeArray(this.volumeArrayCurrentAudio)
        this.resizedArrayAudio.forEach(volume => this.insert(volume, ['opacity']))
      },
  
      resizeArray(inputArray) {
        const targetSize = this.maxElemsInRoad;
    
        if (inputArray.length === targetSize) {
            return inputArray; 
        } else if (inputArray.length < targetSize) {
            const result = [];
            const repeatCount = Math.ceil(targetSize / inputArray.length);
            for (let num of inputArray) {
                for (let i = 0; i < repeatCount; i++) {
                    if (result.length < targetSize) {
                        result.push(num);
                    }
                }
            }
            return result;
        } else {
            const result = [];
            const step = (inputArray.length - 1) / (targetSize - 1);
    
            for (let i = 0; i < targetSize; i++) {
                result.push(inputArray[Math.round(i * step)]);
            }
    
            return result;
        }
      },
  
      startPaintingElems() {
        let count = 0
        const step = Math.floor(this.audioDuration) / this.maxElemsInRoad * 1000
        const reverseChildren = [...globalThis.recordRoad.querySelectorAll('.elem.opacity')].reverse()
  
        this.paintingTimer = setInterval(() => {
          console.log(1)
          if(count >= globalThis.recordRoad.childElementCount || this.audioObject.paused) {
            clearInterval(this.paintingTimer)
            return
          }
            
          reverseChildren[count]?.classList?.remove('opacity')
          count += 1
        }, step)
      },
  
      pausePaintingElems() {
        clearInterval(this.paintingTimer)
      },
  
      submitAudioMessage() {
        globalThis.audioStop.click()
        setTimeout(() => {
          this.insertAudioMessage()
          this.pausePaintingElems()
          this.resetAllVoices()
          globalThis.recordStop.click()
        }, 0)
      },
  
      getAudioMessage: (message)=>{
        const audioMessage = document.createElement('div');
        audioMessage.innerHTML = `
          <div class="chat-message-user-container" data-audio-message>
            <div class="chat-audio-message-user">
              <div class="message-play-btn" data-audio-message-play-btn>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="#2A63EF" width="22" height="25"><g><path d="M26.78,13.45,11.58,4A3,3,0,0,0,7,6.59V25.41a3,3,0,0,0,3,3A3,3,0,0,0,11.58,28l15.2-9.41a3,3,0,0,0,0-5.1Z"></path></g></svg>
              </div>
              <div class="message-pause-btn hidden" data-audio-message-pause-btn>
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 32 32" width="24" fill="#2A63EF"><defs><style>.cls-1{fill:none;}</style></defs><title/><path d="M12,6H10A2,2,0,0,0,8,8V24a2,2,0,0,0,2,2h2a2,2,0,0,0,2-2V8a2,2,0,0,0-2-2Z"/><path d="M22,6H20a2,2,0,0,0-2,2V24a2,2,0,0,0,2,2h2a2,2,0,0,0,2-2V8a2,2,0,0,0-2-2Z"/><rect class="cls-1" data-name="&lt;Transparent Rectangle&gt;" height="32" id="_Transparent_Rectangle_" width="32"/></svg>
              </div>
              <div class="message-audio-container">
                  <div class="road" data-audio-track></div>
                  <div class="message-audio-duration" data-message-audio-duration>00:00</div>
              </div>
            </div>
          </div>
        `
        return audioMessage.firstElementChild
      },
  
      createAudioTrackForMessage(audioMessageHTMLObject) {
        this.resizedArrayAudio.forEach(volume => this.insertElemsInReadyAudioMessage(audioMessageHTMLObject, volume, ['opacity']))
      },
  
      insertElemsInReadyAudioMessage(audioMessageHTMLObject, volume, className = []) {
        const elem = document.createElement('div')
        elem.innerHTML = `<div class="elem ${className.join(' ')}" style="height: ${this.getHeight(volume)}px"></div>`
        audioMessageHTMLObject.querySelector('[data-audio-track]').prepend(elem.firstElementChild)
      },
  
      assignAudioMessageData(audioMessageHTMLObject) {
        audioMessageHTMLObject.audioBlob = [...this.chunks]
        audioMessageHTMLObject.isPaused = false
        audioMessageHTMLObject.timerId = null
        audioMessageHTMLObject.timerMs = 0
        audioMessageHTMLObject.paintingTimer = null
      },
  
      setAudioMessageHandler(audioMessageHTMLObject) {
        this.playAudioMessageHandler(audioMessageHTMLObject)
        this.pauseAudioMessageHandler(audioMessageHTMLObject)
      },
  
      playAudioMessageHandler(audioMessageHTMLObject) {
        audioMessageHTMLObject.querySelector('[data-audio-message-play-btn]').addEventListener('click', () => {
          this.playAudioMessage(audioMessageHTMLObject)
        })
      },
  
      pauseAudioMessageHandler(audioMessageHTMLObject) {
        audioMessageHTMLObject.querySelector('[data-audio-message-pause-btn]').addEventListener('click', () => {
          this.pauseAudioMessage(audioMessageHTMLObject)
        })
      },
  
      playAudioMessage(audioMessageHTMLObject) {
        const helpers = this.helpers
  
        helpers.hidePlayAudioMessage(audioMessageHTMLObject)
        helpers.visiblePauseAudioMessage(audioMessageHTMLObject)
        this.resetAllVoices(audioMessageHTMLObject)
        this.setInitialStateRecordedAudio()
  
        if(!audioMessageHTMLObject.isPaused){
          this.checkAndCloseRecord()
          this.clearAudioObject()
  
          const blob = new Blob(audioMessageHTMLObject.audioBlob)
          this.audioObject.src = URL.createObjectURL(blob)
          this.audioObject.load();
  
          this.audioObject.oncanplaythrough = () => {
            this.audioObject.oncanplaythrough = null
  
            this.audioObject.play()
            this.startPaintingAudioMessageElems(audioMessageHTMLObject)
            this.startTimerAudioMessage(audioMessageHTMLObject)
          }
  
          this.audioObject.onended = () => {
            this.audioObject.onended = null
  
            URL.revokeObjectURL(this.audioObject.src)
  
            this.stopTimerAudioMessage(audioMessageHTMLObject)
            
            audioMessageHTMLObject.isPaused = false
  
            helpers.visiblePlayAudioMessage(audioMessageHTMLObject)
            helpers.hidePauseAudioMessage(audioMessageHTMLObject)
            helpers.transparencyElemsAudioMessage(audioMessageHTMLObject)
          }
  
        } else {
  
          audioMessageHTMLObject.isPaused = false
          this.audioObject.play()
          this.startPaintingAudioMessageElems(audioMessageHTMLObject)
          this.startTimerAudioMessage(audioMessageHTMLObject)
        }
      },
  
      pauseAudioMessage(audioMessageHTMLObject) {
        const helpers = this.helpers
        helpers.visiblePlayAudioMessage(audioMessageHTMLObject)
        helpers.hidePauseAudioMessage(audioMessageHTMLObject)
        audioMessageHTMLObject.isPaused = true
        this.pausePaintingAudioMessageElems(audioMessageHTMLObject)
        this.pauseTimerAudioMessage(audioMessageHTMLObject)
        this.audioObject.pause()
      },
  
      async setDurationAudioMessage(audioMessageHTMLObject) {
        const blob = new Blob(audioMessageHTMLObject.audioBlob)
        const audioContext = new AudioContext()
        const arrayBuffer = await blob.arrayBuffer()
    
        audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
            audioMessageHTMLObject.audioDuration = audioBuffer.duration
    
            let totalSeconds = Math.floor(audioMessageHTMLObject.audioDuration)
    
            let minutes = Math.floor(totalSeconds / 60)
            let seconds = totalSeconds % 60
    
            minutes = minutes < 10 ? '0' + minutes : minutes
            seconds = seconds < 10 ? '0' + seconds : seconds
  
            audioMessageHTMLObject.normalizeDuration = `${minutes}:${seconds}`;
            let durationHTMLObject = audioMessageHTMLObject.querySelector('[data-message-audio-duration]')
            durationHTMLObject.textContent = `${minutes}:${seconds}`
        })
      },
  
      setNormalizeDurationAudioMessage(audioMessageHTMLObject){
        let durationHTMLObject = audioMessageHTMLObject.querySelector('[data-message-audio-duration]')
        durationHTMLObject.textContent = audioMessageHTMLObject.normalizeDuration
      },
  
      startPaintingAudioMessageElems(audioMessageHTMLObject) {
        let count = 0
        const step = Math.floor(audioMessageHTMLObject.audioDuration) / this.maxElemsInRoad * 1000
  
        const reverseChildren = [...audioMessageHTMLObject.querySelectorAll('.elem.opacity')].reverse()
  
        audioMessageHTMLObject.paintingTimer = setInterval(() => {
          if(count >= audioMessageHTMLObject.querySelector('[data-audio-track]').childElementCount || this.audioObject.paused) {
            clearInterval(audioMessageHTMLObject.paintingTimer)
            return
          }
          reverseChildren[count]?.classList?.remove('opacity')
          count += 1
        }, step)
      },
  
      pausePaintingAudioMessageElems(audioMessageHTMLObject) {
        clearInterval(audioMessageHTMLObject.paintingTimer)
      },
  
      startTimerAudioMessage(audioMessageHTMLObject) {
        timer = audioMessageHTMLObject.timerMS ? audioMessageHTMLObject.timerMS : 0
        audioMessageHTMLObject.timerId = setInterval(() => {
            if (timer >= 180 * 100) {
              // audioMessageHTMLObject.querySelector().click()
              clearInterval(audioMessageHTMLObject.timerId)
            }
    
            let totalSeconds = Math.floor(timer / 100)
            let minutes = Math.floor(totalSeconds / 60)
            let seconds = totalSeconds % 60
    
            minutes = minutes < 10 ? '0' + minutes : minutes
            seconds = seconds < 10 ? '0' + seconds : seconds
    
            audioMessageHTMLObject.querySelector('[data-message-audio-duration]').textContent = `${minutes}:${seconds}`
            
            timer++
            audioMessageHTMLObject.timerMS = timer
        }, 10)
      },
  
      pauseTimerAudioMessage(audioMessageHTMLObject) {
        clearInterval(audioMessageHTMLObject.timerId)
      },
  
      stopTimerAudioMessage(audioMessageHTMLObject) {
        audioMessageHTMLObject.timerMS = 0;
        clearInterval(audioMessageHTMLObject.timerId)
      },
  
      checkAndCloseRecord() {
        if(this.isRecording) globalThis.recordStop.click()
      },
  
      setInitialStateRecordedAudio() {
        
        const helpers = this.helpers
  
        globalThis.audioPause.click()
  
        helpers.visibleAudioPlay()
        helpers.hideAudioPause()
        this.setNormalizeDurationAudio()
        this.stopTimer()
        this.isPaused = false
        
        helpers.transparencyElems()
      },
  
      async insertAudioMessage() {
        const audioMessageHTMLObject = this.getAudioMessage()
        this.assignAudioMessageData(audioMessageHTMLObject)
        this.createAudioTrackForMessage(audioMessageHTMLObject)
        this.setAudioMessageHandler(audioMessageHTMLObject)
        await this.setDurationAudioMessage(audioMessageHTMLObject)
        globalThis.chatMessages.appendChild(audioMessageHTMLObject)
        globalThis.chatMessages.scrollTop = globalThis.chatMessages.scrollHeight;
      },
  
      resetAllVoices(audioMessageHTMLObject = null) {
        const helpers = this.helpers
  
        const audioMessagesHTMLObject = document.querySelectorAll('[data-audio-message]')
        if(!audioMessagesHTMLObject.length) return
  
        audioMessagesHTMLObject.forEach(audioMessage => {
          if(audioMessage === audioMessageHTMLObject) return
          helpers.hidePauseAudioMessage(audioMessage)
          helpers.visiblePlayAudioMessage(audioMessage)
  
          this.pausePaintingAudioMessageElems(audioMessage)
          this.stopTimerAudioMessage(audioMessage)
          this.setNormalizeDurationAudioMessage(audioMessage)
          
          audioMessage.timerId = null
          audioMessage.timerMs = 0
          audioMessage.paintingTimer = 0
          audioMessage.isPaused = false
  
          
          audioMessage.querySelectorAll('[data-audio-track] .elem').forEach(elem => elem.classList.add('opacity'))
  
          audioMessagesHTMLObject.isPaused = false
        })
      },
  
      clearState() {
        this.mainMedia = null
        this.chunks = []
        this.isRecording = false
        this.isPaused = false
        this.volumeArrayCurrentAudio = []
        this.resizedArrayAudio = []
        this.audioObject = new Audio()
        this.timerMS = 0
        this.timerId = null
        this.audioDuration = 0
        this.paintingTimer = null
      },
  
      helpers: {
        visibleChatInputContainerInner(){
          globalThis.chatInputContainerInner.classList.remove('hidden')
        },
        hideChatInputContainerInner(){
          globalThis.chatInputContainerInner.classList.add('hidden')
        },
        visibleRecordWrapper(){
          globalThis.recordWrapper.classList.remove('hidden')
        },
        hideRecordWrapper(){
          globalThis.recordWrapper.classList.add('hidden')
        },
        clearRecordRoad(){
          globalThis.recordRoad.innerHTML = ''
        },
        visibleAudioPlay(){
          globalThis.audioPlay.classList.remove('hidden')
        },
        hideAudioPlay(){
          globalThis.audioPlay.classList.add('hidden')
        },
        visibleAudioStop(){
          globalThis.audioStop.classList.remove('hidden')
        },
        hideAudioStop(){
          globalThis.audioStop.classList.add('hidden')
        },
        visibleAudioPause(){
          globalThis.audioPause.classList.remove('hidden')
        },
        hideAudioPause(){
          globalThis.audioPause.classList.add('hidden')
        },
        clearTimerContainer() {
          globalThis.timer.textContent = '00:00'
        },
        transparencyElems() {
          [...globalThis.recordRoad.children].forEach(elem => elem.classList.add('opacity'))
        },
        visiblePlayAudioMessage(audioMessageHTMLObject) {
          audioMessageHTMLObject.querySelector('[data-audio-message-play-btn]').classList.remove('hidden')
        },
        hidePlayAudioMessage(audioMessageHTMLObject) {
          audioMessageHTMLObject.querySelector('[data-audio-message-play-btn]').classList.add('hidden')
        },
        visiblePauseAudioMessage(audioMessageHTMLObject) {
          audioMessageHTMLObject.querySelector('[data-audio-message-pause-btn]').classList.remove('hidden')
        },
        hidePauseAudioMessage(audioMessageHTMLObject) {
          audioMessageHTMLObject.querySelector('[data-audio-message-pause-btn]').classList.add('hidden')
        },
        transparencyElemsAudioMessage(audioMessageHTMLObject) {
          audioMessageHTMLObject.querySelectorAll('[data-audio-track] .elem').forEach(elem => elem.classList.add('opacity'))
        },
      }
    }
  
    this.convertingFunction = {
      parseLinks(message){
        var urlRegex = urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return message.replace(urlRegex, function(url) {
          return '<a href="' + url + '" target="_blank">' + url + '</a>';
        })
      }
    }
  }
  
  const chat = new chatWidget()
  chat.openWebSoket('api.maia.work');
  (function(){
  })();
  